let xmlParsedBodyToJson = {
  OdfBody: {
    $: {
      CompetitionCode: "OWG2022",
      DocumentCode: "HIP-------------------------------",
      DocumentType: "DT_SCHEDULE",
      Version: "3",
      FeedFlag: "P",
      Date: "2022-03-21",
      Time: "115021245",
      LogicalDate: "2022-03-21",
      Source: "ODS",
    },
    Competition: [
      {
        Session: [
          {
            $: {
              SessionCode: "PCO987",
              StartDate: "2022-02-06T20:05:00+08:00",
              EndDate: "2022-03-06T22:05:00+08:00",
              Leadin: "0:00",
              Venue: "USA",
              VenueName: "National Indoor Stadium",
              SessionType: "EVE",
              Medal: "Y",
            },
            SessionName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Session 8",
                },
              },
            ],
          },
          {
            $: {
              SessionCode: "OLV988",
              StartDate: "2022-02-08T09:35:00+08:00",
              EndDate: "2022-03-08T11:35:00+08:00",
              Leadin: "0:00",
              Venue: "NIS",
              VenueName: "National Indoor Stadium",
              SessionType: "MOR",
            },
            SessionName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Session 9",
                },
              },
            ],
          },
        ],
        Unit: [
          {
            $: {
              Code: "CURXTEAM4---00000-----PREL0001111--",
              PhaseType: "2",
              ScheduleStatus: "UNSCHEDULED",
              StartDate: "2022-02-17T12:00:00+08:00",
              HideStartDate: "N",
              EndDate: "2022-02-17T13:00:00+08:00",
              HideEndDate: "N",
              Venue: "NIS",
              Location: "NIS",
              MediaAccess: "OPE",
              ModificationIndicator: "U",
              SessionCode: "BOB05",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Practice Men's Pre-Game SVK",
                },
              },
              {
                $: {
                  Language: "CHI",
                  Value: "Men's Practice Men's Pre-Game",
                },
              },
            ],
            ItemDescription: [
              {
                _: "<p>M SF1 (Away) MNA SVK</p>",
                $: {
                  Language: "ENG",
                },
              },
              {
                _: "<p>M SF (TBA) MNA</p>",
                $: {
                  Language: "SPA",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Indoor Stadium",
                  LocationName: "National Indoor Stadium",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------CNCL000100--",
              PhaseType: "3",
              ScheduleStatus: "UNSCHEDULED",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "No competition",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------CNCL000200--",
              PhaseType: "3",
              ScheduleStatus: "UNSCHEDULED",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "No competition",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------CNCL000300--",
              PhaseType: "3",
              ScheduleStatus: "UNSCHEDULED",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "No competition",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------MEET000100--",
              PhaseType: "9",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-04T14:00:00+08:00",
              EndDate: "2022-03-04T15:00:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
              MediaAccess: "CLO",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Para Biathlon Team Captains' Meeting",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------MEET000200--",
              PhaseType: "9",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-07T17:00:00+08:00",
              EndDate: "2022-03-07T18:00:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
              MediaAccess: "CLO",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Para Biathlon Team Captains' Meeting",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------MEET000300--",
              PhaseType: "9",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-10T16:00:00+08:00",
              EndDate: "2022-03-10T17:00:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
              MediaAccess: "CLO",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Para Biathlon Team Captains' Meeting",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------MEET000400--",
              PhaseType: "9",
              ScheduleStatus: "UNSCHEDULED",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Para Biathlon Team Captains' Meeting",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------MEET000500--",
              PhaseType: "9",
              ScheduleStatus: "UNSCHEDULED",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Para Biathlon Team Captains' Meeting",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------MEET000600--",
              PhaseType: "9",
              ScheduleStatus: "UNSCHEDULED",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Para Biathlon Team Captains' Meeting",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTH-------------------MEET000700--",
              PhaseType: "9",
              ScheduleStatus: "UNSCHEDULED",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Para Biathlon Team Captains' Meeting",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----03030-----FNL-000100--",
              PhaseType: "3",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-11T14:25:00+08:00",
              EndDate: "2022-03-11T15:16:00+08:00",
              HideEndDate: "Y",
              Medal: "1",
              Venue: "ZBT",
              Location: "ZBT",
              SessionCode: "PBTH03",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual VI",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----03030-----TRNO000100--",
              PhaseType: "2",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-10T13:30:00+08:00",
              EndDate: "2022-03-10T15:30:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual VI Off Train",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----03030-----VICTFLOWER--",
              PhaseType: "6",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-11T15:15:00+08:00",
              EndDate: "2022-03-11T15:19:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
              SessionCode: "PBTH03",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual VI Ven Cer",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----03030-----VICTMEDAL---",
              PhaseType: "6",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-11T20:28:00+08:00",
              EndDate: "2022-03-11T20:41:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
              SessionCode: "PMDL12",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual VI Vic Cer",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----09070-----FNL-000100--",
              PhaseType: "3",
              ScheduleStatus: "CANCELLED",
              StartDate: "2022-03-11T12:40:00+08:00",
              EndDate: "2022-03-11T13:27:00+08:00",
              HideEndDate: "Y",
              Medal: "1",
              Venue: "ZBT",
              Location: "ZBT",
              SessionCode: "PBTH03",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual Standing",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----09070-----TRNO000100--",
              PhaseType: "2",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-10T11:15:00+08:00",
              EndDate: "2022-03-10T13:30:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual Standing Off Train",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----09070-----VICTFLOWER--",
              PhaseType: "6",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-11T13:25:00+08:00",
              EndDate: "2022-03-11T13:29:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
              SessionCode: "PBTH03",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual Standing Ven Cer",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----09070-----VICTMEDAL---",
              PhaseType: "6",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-11T19:41:00+08:00",
              EndDate: "2022-03-11T19:51:00+08:00",
              Medal: "0",
              Venue: "ZBT",
              Location: "ZBT",
              SessionCode: "PMDL12",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual Standing Vic Cer",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "BTHMLONG----12050-----FNL-000100--",
              PhaseType: "3",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-03-11T10:30:00+08:00",
              EndDate: "2022-03-11T11:19:00+08:00",
              HideEndDate: "Y",
              Medal: "1",
              Venue: "ZBT",
              Location: "ZBT",
              SessionCode: "PBTH03",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Individual Sitting",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Biathlon Centre",
                  LocationName: "National Biathlon Centre",
                },
              },
            ],
          },
          {
            $: {
              Code: "CURXTEAM4---00000-----PREL002222--",
              PhaseType: "2",
              ScheduleStatus: "SCHEDULED",
              StartDate: "2022-02-17T12:00:00+08:00",
              HideStartDate: "N",
              EndDate: "2022-02-17T13:00:00+08:00",
              HideEndDate: "N",
              Venue: "NIS",
              Location: "NIS",
              MediaAccess: "OPE",
              ModificationIndicator: "U",
              SessionCode: "BOB05",
            },
            ItemName: [
              {
                $: {
                  Language: "ENG",
                  Value: "Men's Practice Men's Pre-Game SVK",
                },
              },
              {
                $: {
                  Language: "CHI",
                  Value: "Men's Practice Men's Pre-Game",
                },
              },
            ],
            ItemDescription: [
              {
                _: "<p>M SF1 (Away) MNA SVK</p>",
                $: {
                  Language: "ENG",
                },
              },
              {
                _: "<p>M SF (TBA) MNA</p>",
                $: {
                  Language: "SPA",
                },
              },
            ],
            VenueDescription: [
              {
                $: {
                  VenueName: "National Indoor Stadium",
                  LocationName: "National Indoor Stadium",
                },
              },
            ],
          },
        ],
      },
    ],
  },
};
'use strict';

const fs = require('fs');
const path = require('path');

async function eventsGenerator(payload) {
  const events = {};
  const sports = await readJSONFile(
    path.resolve(__dirname, '../commonCodes/sports.json')
  );
  const sportsSpecificCodes = await readJSONFile(
    path.resolve(__dirname, '../commonCodes/sportSpecificCodes.json')
  );
  const gender = await readJSONFile(
    path.resolve(__dirname, '../commonCodes/sportGenders.json')
  );

  const commonData = {
    competitionCode: payload['OdfBody']['$']['CompetitionCode'],
    documentCode: payload['OdfBody']['$']['DocumentCode'],
    sports,
    gender,
    sportsSpecificCodes,
  };
  if (payload['OdfBody']['Competition'][0]['Session']) {
    events.OlympicsSession = generateSessionEvents(
      commonData,
      payload['OdfBody']['Competition'][0]['Session']
    );
  }
  if (payload['OdfBody']['Competition'][0]['Unit']) {
    events.OlympicsUnit = generateUnitEvents(
      commonData,
      payload['OdfBody']['Competition'][0]['Unit']
    );
  }
  return events;
}

async function readJSONFile(path) {
  const response = await fs.readFileSync(path, { encoding: 'utf-8' });
  return JSON.parse(response);
}

function getValueOfGender(commonData, genderId) {
  let gender;
  commonData.gender.find((item) => {
    if (genderId === item.id) gender = item.gender;
  });
  return gender;
}

function getSportType(commonData, sportCodeId) {
  let sportType;
  commonData.sports.find((sport) => {
    if (sportCodeId === sport.sportCode) sportType = sport.sport;
  });
  return sportType;
}

function getEventStage(commonData, stageId) {
  let eventStage;
  commonData.sportsSpecificCodes.find((sport) => {
    if (stageId === sport.code) eventStage = sport.description;
  });
  return eventStage;
}

function generateSessionEvents(commonData, session) {
  const sessionEvents = [];
  session.forEach((session) => {
    const sportType = getSportType(
      commonData,
      session['$']['SessionCode'].substr(0, 3)
    );
    const sessionEventBody = {
      publisherId: 'd90972a3-65a5-447d-ae7b-084b8df9786d',
      clientEventId: session['$']['SessionCode'],
      eventTypeCode: 'OlympicsSession',
      eventBody: {
        code: session['$']['SessionCode'],
        sportType: sportType,
        SessionName: session['SessionName']
          ? session['SessionName'][0]['$']['Value']
          : undefined,
        Medal: session['$']['Medal'],
        startDateTime: session['$']['StartDate'],
        endDate: session['$']['EndDate'],
        SessionType: session['$']['SessionType'],
        competition: {
          code: commonData.competitionCode,
          documentCode: commonData.documentCode,
        },
      },
      eventLocation: {
        venue: session['$']['Venue'],
        VenueName: session['$']['VenueName'],
      },
      startDate: session['$']['StartDate'],
      endDate: session['$']['EndDate'],
    };
    sessionEvents.push(sessionEventBody);
  });
  return sessionEvents;
}

function generateUnitEvents(commonData, units) {
  const unitEvents = [];

  units.forEach((unit) => {
    if (
      unit['$']['ScheduleStatus'] === 'UNSCHEDULED' ||
      unit['$']['ScheduleStatus'] === 'CANCELLED' ||
      unit['$']['ScheduleStatus'] === 'POSTPONED'
    ) {
      return;
    }
    const eventStage = getEventStage(
      commonData,
      unit['$']['Code'].substr(22, 4)
    );
    const sportType = getSportType(commonData, unit['$']['Code'].substr(0, 3));
    const gender = getValueOfGender(commonData, unit['$']['Code'][3]);

    const unitEventBody = {
      publisherId: 'd90972a3-65a5-447d-ae7b-084b8df9786d',
      clientEventId: unit['$']['Code'],
      eventTypeCode: 'OlympicsUnit',
      eventStatus: {
        name: unit['$']['ScheduleStatus'],
      },
      eventBody: {
        code: unit['$']['Code'],
        sportType: sportType,
        gender: gender,
        phaseType: unit['$']['PhaseType'],
        eventName: undefined,
        eventStage: eventStage,
        medal: unit['$']['Medal'],
        itemName: unit['ItemName']
          ? unit['ItemName'][0]['$']['Value']
          : undefined,
        sessionCode: unit['$']['SessionCode'],
        startDateTime: unit['$']['StartDate'],
        eventStatus: {
          name: unit['$']['ScheduleStatus'],
        },
        competition: {
          code: commonData.competitionCode,
          documentCode: commonData.documentCode,
        },
      },
      eventLocation: {
        VenueName: unit['VenueDescription']
          ? unit['VenueDescription'][0]['$']['VenueName']
          : undefined,
        LocationName: unit['VenueDescription']
          ? unit['VenueDescription'][0]['$']['VenueName']
          : undefined,
      },
      startDate: unit['$']['StartDate'],
      endDate: unit['$']['EndDate'],
    };
    if (unit['ItemName'] && eventStage) {
      unitEventBody.eventBody.eventName =
      `${sportType} - ${unit['ItemName'][0]['$']['Value']} - ${eventStage}`;
    }
    unitEvents.push(unitEventBody);
  });
  return unitEvents;
}

let eventBody = eventsGenerator(xmlParsedBodyToJson);

eventBody.then((r) => {
  // console.log(r.OlympicsSession);
  console.log(r.OlympicsUnit.length);
});
